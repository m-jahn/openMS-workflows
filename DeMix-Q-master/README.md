### DeMix-Q: Quantification-centered LC-MS/MS data processing
------
__Dependencies:__  
* __OpenMS 2.0__
    - For Windows and macOS: http://www.openms.de/download/openms-binaries
    - For Ubuntu 16.10 (yakkety yak):  <code>sudo apt-get install openms </code>


*  [Anaconda](https://www.continuum.io/downloads) __Python 2.7 or 3.5__
    <code> pip install numpy pandas lxml pymzml pyteomics </code>
    * numpy
    * pandas
    * lxml  
    * pymzml http://pymzml.github.io/  
    * pyteomics http://pythonhosted.org//pyteomics/

Optional:
* msconvert (ProteoWizard) http://proteowizard.sourceforge.net/index.shtml  
* MS-GF+ http://omics.pnl.gov/software/ms-gf


---
__Procedures:__   

First of all, in order to enable external tools for XIC extraction:
- Copy the __consensus2edta.ttd__ config file to the OpenMS installation path (e.g. C:\Program Files\OpenMS-2.0\share\OpenMS\TOOLS\EXTERNAL).

After copying the configure file to the OpenMS path:

- Load the __DeMix_PoseCluster.toppas__ (new version, recommended) or the __DeMix.toppas__ pipeline (old version) in the TOPPAS program.

for __DeMix_PoseCluster.toppas__:
- Prepare centroid MS1 spectra in mzML format and load in __"Node 1"__.
- Load the corresponding MS/MS identification files (__".idXML"__ format) in __"Node 2"__. MS-GF+ resultant mzid files can be converted by the python script: __mzid2idxml_theomass.py__ .  _(Note: the script only fetches RT information from spectrum titles that are generated by DeMix. In the case that you do not work with the DeMix identification workflow and MS-GF+, please revise it before use.)_
- In __"Node 3"__, load the corresponding __".FeatureXML"__ files in (i.e. individual feature maps) that are previously generated by the _FeatureFinderCentroided_ (for example, from the DeMix workflow).
- In __"Node 4"__, load __ONE ".FeatureXML"__ file as the __reference__ for retention time alignment. _(Recommend to choose one of the files in Node 3 that has the largest number of features. RT scales of other runs will be re-calibrated to the scale of the reference run after alignment)._
- Modify __"Node 14"__ in the pipeline, set the __converter_script__ option to point to the python script: __consensus2edta.py__

alternatively, for __DeMix.toppas__:
- Prepare centroid MS1 spectra in mzML format and load in __"Node 1"__.
- Load the corresponding MS/MS identification files (__".idXML"__ format) in __"Node 3"__. MS-GF+ resultant mzid files can be converted by the python script: __mzid2idxml_theomass.py__ .  _(Note: the script only fetches RT information from spectrum titles that are generated by DeMix. In the case that you do not work with the DeMix identification workflow and MS-GF+, please revise it before use.)_
- In __"Node 4"__, load __ONE ".idXML"__ file as the __reference__ for retention time alignment. _(Recommend to choose one of the files in Node 3 that has the largest number of identifications. RT scales of other runs will be re-calibrated to the scale of the reference run after alignment.)_
- Modify __"Node 17"__ in the pipeline, set the __converter_script__ option to point to the python script: __consensus2edta.py__


After configuration,
- Execute the pipeline in TOPPAS (by pressing F5).
- Collect two output files from processes of TextExporter and EICExtractor.

Finally,
- Apply the post processing Python script __DeMixQ_data_processing.py__ in the script folder. Set parameters as follows:

    <pre>
-consensus  The consensus feature map (default: consensus.csv)
-eic        The extracted ion-chromatography (default: eic.csv)
-n_samples  number of samples (default: 4)
-n_repeats  number of replicate experiments per sample (default: 3)
-fdr        Quality cutoff by estimating FDR from decoy extractions (default: 0.05)
-knn_k      K nearest neighbors for abundance correction, set 0 to disable correction (default: 5)
-knn_step   Number of sequential features used for estimating local medians (default: 500)
-out        Output table in csv format (default: peptides.DeMixQ.csv)
</pre>

- Alternatively, there is an example __iPython notebook__ in the script folder, which can be executed step-by-step using Jupyter notebook (Python2.7).


__Note:__  
The example workflow is tested with high resolution Orbitrap (FTMS 70,000) datasets. You may need to adjust the parameters to fit with your dataset.

Map RT alignment can be done without MS/MS identifications, or done with other tools then convert into the OpenMS-compatible format (i.e. trafoXML).

For a large dataset (e.g. >10 samples), feature detection and linking may require considerable computing resources: CPU, RAM and disk space.

---

__Download the example data set__   
https://ki.box.com/s/15kv73pu2cvi4gwakzd6kdxcwch7dbl0


---
##### Reference
<ol> <li> Zhang, B., KÃ¤ll, L. & Zubarev, R. A., (2016). DeMix-Q: Quantification-centered Data Processing Workflow. Molecular & Cellular Proteomics, mcp.O115.055475  
http://www.ncbi.nlm.nih.gov/pubmed/26729709 </li>

<li>Zhang, B., Pirmoradian, M., Chernobrovkin, A., & Zubarev, R. A. (2014). DeMix Workflow for Efficient Identification of Co-fragmented Peptides in High Resolution Data-dependent Tandem Mass Spectrometry. Molecular & Cellular Proteomics : MCP. doi:10.1074/mcp.O114.038877
http://www.ncbi.nlm.nih.gov/pubmed/25100859</li></ol>
